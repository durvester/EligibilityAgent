// Prisma Schema for SMART on FHIR Eligibility Agent
// Database: PostgreSQL
// Architecture: Tenant-centric (issuer = practice = tenant)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Tenant - issuer IS the tenant identifier
// First login with an issuer creates a new tenant
model Tenant {
  id                 String   @id @default(uuid())
  issuer             String   @unique // FHIR base URL as primary business key
  name               String? // From Organization FHIR resource
  organizationFhirId String?  @map("organization_fhir_id")
  organizationJson   Json?    @map("organization_json")
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")

  sessions  Session[]
  agentRuns AgentRun[]
  auditLogs AuditLog[]

  @@map("tenants")
}

// Session - holds internal JWT + PF tokens
// Internal JWTs are used for ALL internal API communication
// PF OAuth tokens are ONLY for FHIR and SSO
model Session {
  id         String  @id @default(uuid())
  tenantId   String  @map("tenant_id")
  userFhirId String? @map("user_fhir_id")
  userName   String? @map("user_name")

  // Internal JWT - short-lived, refreshable
  internalJwtId        String   @unique @map("internal_jwt_id")
  internalJwtExpiresAt DateTime @map("internal_jwt_expires_at")

  // PF OAuth tokens (encrypted) - ONLY for FHIR/SSO
  pfAccessTokenEncrypted  String    @map("pf_access_token_encrypted")
  pfRefreshTokenEncrypted String?   @map("pf_refresh_token_encrypted")
  pfTokenExpiresAt        DateTime  @map("pf_token_expires_at")
  tokenEndpoint           String?   @map("token_endpoint") // OAuth token endpoint for refresh
  ehrIdentifier           String?   @map("ehr_identifier") // EHR system identifier (e.g., 'PF', 'VERADIGM') for token refresh

  patientId      String?  @map("patient_id")
  scope          String?
  lastAccessedAt DateTime @default(now()) @map("last_accessed_at")
  createdAt      DateTime @default(now()) @map("created_at")

  // Revocation flag - set to true when user logs out
  revoked   Boolean   @default(false)
  revokedAt DateTime? @map("revoked_at")

  tenant Tenant @relation(fields: [tenantId], references: [id])

  @@index([internalJwtId])
  @@index([tenantId, userFhirId])
  @@index([tenantId, patientId])
  @@map("sessions")
}

// AgentRun - stores final agent output only (not streaming events)
// Streaming happens in-memory via SSE; we persist the final result
model AgentRun {
  id            String  @id @default(uuid())
  tenantId      String  @map("tenant_id")
  sessionId     String? @map("session_id")
  patientFhirId String  @map("patient_fhir_id")
  inputPayload  Json    @map("input_payload")
  status        String // running, completed, failed

  // Final outputs (stored on completion)
  eligibilityResult Json?   @map("eligibility_result")
  summary           String? @db.Text
  discrepancies     Json?
  rawStediResponse  Json?   @map("raw_stedi_response")

  // Usage metrics
  inputTokens   Int?     @map("input_tokens")
  outputTokens  Int?     @map("output_tokens")
  estimatedCost Decimal? @map("estimated_cost") @db.Decimal(10, 6)

  // Timing
  startedAt   DateTime  @default(now()) @map("started_at")
  completedAt DateTime? @map("completed_at")
  durationMs  Int?      @map("duration_ms")

  // Error info (if failed)
  errorMessage String? @map("error_message")

  tenant Tenant @relation(fields: [tenantId], references: [id])

  @@index([tenantId, startedAt(sort: Desc)])
  @@index([tenantId, patientFhirId])
  @@map("agent_runs")
}

// NOTE: AgentEvent table intentionally omitted
// Streaming events are handled in-memory via SSE during execution
// Only final outputs are persisted to AgentRun for history/debugging

// AuditLog - HIPAA mandatory
// Fire-and-forget - never blocks requests
model AuditLog {
  id            String   @id @default(uuid())
  tenantId      String   @map("tenant_id")
  sessionId     String?  @map("session_id")
  userFhirId    String?  @map("user_fhir_id")
  userName      String?  @map("user_name")
  action        String // login, logout, view_patient, check_eligibility
  resourceType  String?  @map("resource_type")
  resourceId    String?  @map("resource_id")
  patientFhirId String?  @map("patient_fhir_id")
  requestIp     String?  @map("request_ip")
  userAgent     String?  @map("user_agent")
  requestPath   String?  @map("request_path")
  success       Boolean  @default(true)
  errorCode     String?  @map("error_code")
  errorMessage  String?  @map("error_message")
  details       Json?
  createdAt     DateTime @default(now()) @map("created_at")

  tenant Tenant @relation(fields: [tenantId], references: [id])

  @@index([tenantId, createdAt(sort: Desc)])
  @@index([tenantId, patientFhirId])
  @@index([sessionId])
  @@map("audit_logs")
}
